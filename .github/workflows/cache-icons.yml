name: Cache External Icons Refresh

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:

permissions:
  contents: write 
  pull-requests: write

jobs:
  update-icons:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          permission-contents: 'write' # Needed for checkout, commit, and push

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main 
          # Use the token generated by the step above
          token: ${{ steps.app-token.outputs.token }} 

      - name: Create New Branch
        id: branch_creation
        run: |
          BRANCH_NAME="feat/icon-cache-update-$(date +'%Y-%m-%d')"
          git checkout -b $BRANCH_NAME
          echo "NEW_BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm install

      - name: Run Icon Cache Script
        run: npm run download-icons
          
      - name: Check for Changes
        id: git_status
        run: |
          if [ -n "$(git status --porcelain icons/)" ]; then
            echo "files_changed=true" >> $GITHUB_OUTPUT
          else
            echo "files_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit Changes
        if: steps.git_status.outputs.files_changed == 'true'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add icons/
          git commit -m "ðŸ¤– Auto-update: Refresh cached external icons"
          git push -u origin ${{ env.NEW_BRANCH_NAME }} # Push the new branch

      - name: Create Pull Request
        if: steps.git_status.outputs.files_changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: 'ðŸ¤– Auto-update: Refresh cached external icons'
          title: 'Update: Latest external icons cache'
          body: |
            This is an automated pull request to update the local cache of external icons.
            
            Please review and merge.
          branch: ${{ env.NEW_BRANCH_NAME }}
          base: main
          delete-branch: true